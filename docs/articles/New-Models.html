<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New-Models â€¢ GOF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="New-Models">
<meta property="og:description" content="GOF">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GOF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Architecture.html">Architecture</a>
    </li>
    <li>
      <a href="../articles/New-Models.html">New-Models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarselScheer/GOF/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="New-Models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>New-Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MarselScheer/GOF/blob/master/vignettes/New-Models.Rmd"><code>vignettes/New-Models.Rmd</code></a></small>
      <div class="hidden name"><code>New-Models.Rmd</code></div>

    </div>

    
    
<p>Usually, one creates a GOF-model-test-class via the function <em>GOF_model()</em>. But this function is actually a wrapper for the class <em>GOF_model_test</em>. That class needs other classes to work properly. In particular it uses the three interfaces <em>GOF_model_info_extractor</em>, <em>GOF_model_simulator</em>, <em>GOF_model_trainer</em>. In general, objects of class <em>lm</em> or <em>glm</em> can be used with <em>GOF_model</em>. However, there might be situations where one has to overwrite the default behavior. For instance, if you want to apply the methodology to new models or simply because a model fit returned by an R-package does not work properly with the GOF-package. Here we show how to implement the three interfaces for some concret cases.</p>
<div id="least-square-estimates" class="section level1">
<h1 class="hasAnchor">
<a href="#least-square-estimates" class="anchor"></a>Least square estimates</h1>
<p>Assume we have such a model</p>
<p><span class="math display">\[
Y = m(\beta^\top X) + \epsilon
\]</span></p>
<p>without any knowledge about <span class="math inline">\(\epsilon\)</span>. Then we could try to estimate the <span class="math inline">\(\beta\)</span> using a least square estimate and using the GOF-package for check our fitted model. First we generate a data set</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">GOF</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="no">X</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">200</span>, <span class="kw">min</span> <span class="kw">=</span> <span class="fl">6</span>, <span class="kw">max</span> <span class="kw">=</span> <span class="fl">14</span>)
<span class="no">d</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span>(<span class="fl">0.5</span> * <span class="no">X</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">200</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fl">0.2</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">y</span>~<span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>)</pre></body></html></div>
<p><img src="New-Models_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>Lets have a short excursion at this point because the plot gives the impression that the following simple model might apply:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">wrong_model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">y</span> ~ <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(<span class="no">x</span>^<span class="fl">2</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>)</pre></body></html></div>
<p>However, a goodness-of-fit-test rejects this model</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">mt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/GOF_model.html">GOF_model</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>,
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">wrong_model</span>,
  <span class="kw">simulator_type</span> <span class="kw">=</span> <span class="st">"parametric"</span>,
  <span class="kw">nmb_boot_samples</span> <span class="kw">=</span> <span class="fl">100</span>,
  <span class="kw">y_name</span> <span class="kw">=</span> <span class="st">"y"</span>,
  <span class="kw">Rn1_statistic</span> <span class="kw">=</span> <span class="no">Rn1_KS</span>$<span class="fu">new</span>())
<span class="no">mt</span>$<span class="fu">get_pvalue</span>()
<span class="co">#&gt; [1] 0</span></pre></body></html></div>
<p>Note that in this simple case the standard diagnostic plots also reveal that this model is not a sufficient. Now we fit the model using a least square estimator:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="kw pkg">minpack.lm</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/minpack.lm/man/nlsLM.html">nlsLM</a></span>(<span class="no">y</span> ~ <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span>(<span class="no">a</span> * <span class="no">x</span>),
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>,
  <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">a</span> <span class="kw">=</span> <span class="fl">0.5</span>),
  <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.control.html">nls.control</a></span>(<span class="kw">maxiter</span> <span class="kw">=</span> <span class="fl">500</span>))
<span class="no">fit</span>
<span class="co">#&gt; Nonlinear regression model</span>
<span class="co">#&gt;   model: y ~ sin(a * x)</span>
<span class="co">#&gt;    data: d</span>
<span class="co">#&gt;      a </span>
<span class="co">#&gt; 0.4993 </span>
<span class="co">#&gt;  residual sum-of-squares: 7.873</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of iterations to convergence: 3 </span>
<span class="co">#&gt; Achieved convergence tolerance: 1.49e-08</span></pre></body></html></div>
<p>In order to create a goodnes-of-fit-test using <em>GOF_model_test</em> we have to implement three interfaces. The first interface requires that we implement three functions <em>yhat</em>, <em>y_minus_yhat</em> and <em>beta_x_covariates</em>, which are the predictions for the dependent variable (also called target-variable), the residuals on the scale of the dependent variable and the inner product of the estimated parameters and the independent variables (also called covariates or features). However, the object returned by <em>minpack.lm::nlsLM</em> does not contain the original data set but that data set is necessary to calculate the inner product. Hence, we make a list that contains the model fit and the data that was used to fit the model.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">fit_and_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">fit</span> <span class="kw">=</span> <span class="no">fit</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>)</pre></body></html></div>
<p>Now we can implement the interface</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">my_nls_info_extractor</span> <span class="kw">&lt;-</span> <span class="kw pkg">R6</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/R6/man/R6Class.html">R6Class</a></span>(
  <span class="kw">classname</span> <span class="kw">=</span> <span class="st">"my_nls_info_extractor"</span>,
  <span class="kw">inherit</span> <span class="kw">=</span> <span class="no">GOF_model_info_extractor</span>,
  <span class="kw">public</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">yhat</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">model</span>) {
      <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">object</span> <span class="kw">=</span> <span class="no">model</span>$<span class="no">fit</span>)
    },
    <span class="kw">y_minus_yhat</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">model</span>) {
      <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="kw">object</span> <span class="kw">=</span> <span class="no">model</span>$<span class="no">fit</span>)
    },
    <span class="kw">beta_x_covariates</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">model</span>) {
      <span class="no">a_hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="kw">object</span> <span class="kw">=</span> <span class="no">model</span>$<span class="no">fit</span>)
      <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">model</span>$<span class="no">data</span>$<span class="no">x</span>
      <span class="no">ret</span> <span class="kw">&lt;-</span> <span class="no">a_hat</span> * <span class="no">x</span>
      <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">ret</span>)
    }
  ))
<span class="no">my_info_extractor</span> <span class="kw">&lt;-</span> <span class="no">my_nls_info_extractor</span>$<span class="fu">new</span>()</pre></body></html></div>
<p>Implementing <em>yhat</em> and <em>y_minus_yhat</em> is straight forward using the function already offered by R but <em>beta_x_covariates</em> needs special attention. The reason is that <em>minpack.lm::nlsLM</em> can also fit very general models of the type <span class="math inline">\(m(\beta, X)\)</span>. Hence, there is now built-in-function to extract objects like <span class="math inline">\(\beta^\top X\)</span>. Lets look at the first few data points:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">d</span>)
<span class="co">#&gt;           x          y</span>
<span class="co">#&gt; 1  8.124069 -0.9199426</span>
<span class="co">#&gt; 2  8.976991 -0.9666172</span>
<span class="co">#&gt; 3 10.582827 -1.0191812</span>
<span class="co">#&gt; 4 13.265662  0.3741709</span>
<span class="co">#&gt; 5  7.613455 -0.7480823</span>
<span class="co">#&gt; 6 13.187117  0.6588717</span></pre></body></html></div>
<p>Now we are able to predict <span class="math inline">\(y\)</span>:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">my_info_extractor</span>$<span class="fu">yhat</span>(<span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>))
<span class="co">#&gt; [1] -0.7926252 -0.9737135 -0.8407826  0.3343611 -0.6132205  0.2971500</span></pre></body></html></div>
<p>And calculate the difference between <span class="math inline">\(y\)</span> and our prediction:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">my_info_extractor</span>$<span class="fu">y_minus_yhat</span>(<span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>))
<span class="co">#&gt; [1] -0.127317499  0.007096259 -0.178398577  0.039809752 -0.134861797</span>
<span class="co">#&gt; [6]  0.361721696</span></pre></body></html></div>
<p>And based on the estimated coefficient we can calculate the inner product with <span class="math inline">\(x\)</span>:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">my_info_extractor</span>$<span class="fu">beta_x_covariates</span>(<span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>))
<span class="co">#&gt; [1] 4.056695 4.482596 5.284458 6.624113 3.801724 6.584892</span></pre></body></html></div>
<p>Since we did not make an assumption about the distribution of <span class="math inline">\(\epsilon\)</span> we cannot use a parametric resampling scheme. However, we can do a wild bootstrap that uses only the predictions and the residuals. The class <em>GOF_sim_wild_rademacher</em> implements this wild bootstrap but needs an info extractor to obtain the preditions and residuals:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">my_simulator</span> <span class="kw">&lt;-</span> <span class="no">GOF_sim_wild_rademacher</span>$<span class="fu">new</span>(
  <span class="kw">gof_model_info_extractor</span> <span class="kw">=</span> <span class="no">my_info_extractor</span>
)</pre></body></html></div>
<p>This class generates as many observations (according to the fitted model) as are contained in the data set used to fit the model.</p>
<p>Again looking at first at the original data points:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">d</span>)
<span class="co">#&gt;           x          y</span>
<span class="co">#&gt; 1  8.124069 -0.9199426</span>
<span class="co">#&gt; 2  8.976991 -0.9666172</span>
<span class="co">#&gt; 3 10.582827 -1.0191812</span>
<span class="co">#&gt; 4 13.265662  0.3741709</span>
<span class="co">#&gt; 5  7.613455 -0.7480823</span>
<span class="co">#&gt; 6 13.187117  0.6588717</span></pre></body></html></div>
<p>Now lets look at new <span class="math inline">\(y\)</span>s generated according to the fitted model, i.e.Â following a negative binomial distribution subject to the independent variables:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">my_simulator</span>$<span class="fu">resample_y</span>(<span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>))
<span class="co">#&gt; [1] -0.6653077 -0.9808097 -1.0191812  0.3741709 -0.4783588  0.6588717</span></pre></body></html></div>
<p>Note that the resampled <span class="math inline">\(y\)</span>â€™s sometimes equal the observed <span class="math inline">\(y\)</span>. The reason is that the this wild bootstrap performs â€˜predictions +/- residualâ€™ and only the sign is drawn at random.</p>
<p>Finally, we need to implement the interface <em>GOF_model_trainer</em> which requires a function <em>refit</em> that is able to update the model object by refitting it to a new data set. R already provides the necessary function, i.e.Â <em>stats::update</em>. However we combined the fitted model with the data set in a list and we need to take into account:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">my_nls_trainer</span> <span class="kw">&lt;-</span> <span class="kw pkg">R6</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/R6/man/R6Class.html">R6Class</a></span>(
  <span class="kw">classname</span> <span class="kw">=</span> <span class="st">"GOF_nls_trainer"</span>,
  <span class="kw">inherit</span> <span class="kw">=</span> <span class="no">GOF_model_trainer</span>,
  <span class="kw">public</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">refit</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">model</span>, <span class="no">data</span>) {
      <span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(<span class="kw">object</span> <span class="kw">=</span> <span class="no">model</span>$<span class="no">fit</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>)
      <span class="no">ret</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">fit</span> <span class="kw">=</span> <span class="no">fit</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>)
      <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">ret</span>)
    }))
<span class="no">my_trainer</span> <span class="kw">&lt;-</span> <span class="no">my_nls_trainer</span>$<span class="fu">new</span>()</pre></body></html></div>
<p>This implementation basically equals the implementation of <em>GOF_lm/glm/_trainer</em>. The only difference is that we again store the data with the fit because <em>nlsLM()</em> doesnâ€™t do it for us.</p>
<p>Of course, fitting the model again to the original data set results in the same fitted model. With the defined classes we can now easily generate a new data set and refit the model to that new data set.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">new_data</span> <span class="kw">&lt;-</span> <span class="no">d</span>
<span class="no">new_data</span>$<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">my_simulator</span>$<span class="fu">resample_y</span>(<span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>)
<span class="no">my_trainer</span>$<span class="fu">refit</span>(<span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">new_data</span>)$<span class="no">fit</span>
<span class="co">#&gt; Nonlinear regression model</span>
<span class="co">#&gt;   model: y ~ sin(a * x)</span>
<span class="co">#&gt;    data: data</span>
<span class="co">#&gt;      a </span>
<span class="co">#&gt; 0.4997 </span>
<span class="co">#&gt;  residual sum-of-squares: 7.871</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of iterations to convergence: 2 </span>
<span class="co">#&gt; Achieved convergence tolerance: 1.49e-08</span></pre></body></html></div>
<p>Now all ingredients are available for applying the Goodness-of-Fit test:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="no">mt</span> <span class="kw">&lt;-</span> <span class="no">GOF_model_test</span>$<span class="fu">new</span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">fit_and_data</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>,
  <span class="kw">nmb_boot_samples</span> <span class="kw">=</span> <span class="fl">100</span>,
  <span class="kw">y_name</span> <span class="kw">=</span> <span class="st">"y"</span>,
  <span class="kw">Rn1_statistic</span> <span class="kw">=</span> <span class="no">Rn1_CvM</span>$<span class="fu">new</span>(),
  <span class="kw">gof_model_info_extractor</span> <span class="kw">=</span> <span class="no">my_info_extractor</span>,
  <span class="kw">gof_model_resample</span> <span class="kw">=</span> <span class="no">GOF_model_resample</span>$<span class="fu">new</span>(
    <span class="kw">gof_model_simulator</span> <span class="kw">=</span> <span class="no">my_simulator</span>,
    <span class="kw">gof_model_trainer</span> <span class="kw">=</span> <span class="no">my_trainer</span>
  )
)
<span class="no">mt</span>$<span class="fu">get_pvalue</span>()
<span class="co">#&gt; [1] 0.8</span></pre></body></html></div>
</div>
<div id="negative-binomial-using-the-mass-package" class="section level1">
<h1 class="hasAnchor">
<a href="#negative-binomial-using-the-mass-package" class="anchor"></a>Negative Binomial using the MASS-package</h1>
<p>A negative binomial model is a generalized linear model. Furthermore, within R MASS::glm.nb returns an object of class <em>glm</em> and this package actually can process <em>glm</em>-classes. However, MASS::glm.nb seems to have a bug that prevents to propoerly update/refit such an object via the stats::update() function. We briefly illustrate this using an artificial data set:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">MASS</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="no">X1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">100</span>)
<span class="no">X2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">100</span>)
<span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">y</span> <span class="kw">=</span> <span class="kw pkg">MASS</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/rnegbin.html">rnegbin</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">mu</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fl">0.2</span> + <span class="no">X1</span> * <span class="fl">0.2</span> + <span class="no">X2</span> * <span class="fl">0.6</span>), <span class="kw">theta</span> <span class="kw">=</span> <span class="fl">2</span>),
  <span class="kw">x1</span> <span class="kw">=</span> <span class="no">X1</span>,
  <span class="kw">x2</span> <span class="kw">=</span> <span class="no">X2</span>)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="kw pkg">MASS</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span>(<span class="no">y</span>~<span class="no">x1</span>+<span class="no">x2</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>)
<span class="no">fit</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:  MASS::glm.nb(formula = y ~ x1 + x2, data = d, init.theta = 1.561918046, </span>
<span class="co">#&gt;     link = log)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt; (Intercept)           x1           x2  </span>
<span class="co">#&gt;      0.1905       0.1532       0.7696  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Degrees of Freedom: 99 Total (i.e. Null);  97 Residual</span>
<span class="co">#&gt; Null Deviance:       144.3 </span>
<span class="co">#&gt; Residual Deviance: 102.4     AIC: 317.5</span></pre></body></html></div>
<p>Note that fit-object shows that the call contained the parameter <em>init.theta</em> which obviously was not provided by us. The problem is that this <em>init.theta</em> parameter is used by <em>stats::update</em> during refitting resampled data. So fitting resampled data and fitting the original data is slightly different from the perspective of the fitting algorithm. To circumvent this problem we can reimplement the corresponding interface as follows:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">my_negbin_trainer</span> <span class="kw">&lt;-</span> <span class="kw pkg">R6</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/R6/man/R6Class.html">R6Class</a></span>(
  <span class="kw">classname</span> <span class="kw">=</span> <span class="st">"GOF_glmnb_trainer"</span>,
  <span class="kw">inherit</span> <span class="kw">=</span> <span class="no">GOF_model_trainer</span>,
  <span class="kw">public</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">refit</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">model</span>, <span class="no">data</span>) {
      <span class="kw pkg">MASS</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span>(<span class="kw">formula</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span>(<span class="no">model</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>)
    }))</pre></body></html></div>
<p>This way we ensure that the original data set and resampled data set are fitted in the same way. Now we can create the GOF-test-class using this new refitting-class</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="no">mt</span> <span class="kw">&lt;-</span> <span class="no">GOF_model_test</span>$<span class="fu">new</span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">fit</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>,
  <span class="kw">nmb_boot_samples</span> <span class="kw">=</span> <span class="fl">100</span>,
  <span class="kw">y_name</span> <span class="kw">=</span> <span class="st">"y"</span>,
  <span class="kw">Rn1_statistic</span> <span class="kw">=</span> <span class="no">Rn1_CvM</span>$<span class="fu">new</span>(),
  <span class="kw">gof_model_info_extractor</span> <span class="kw">=</span> <span class="no">GOF_glm_info_extractor</span>$<span class="fu">new</span>(),
  <span class="kw">gof_model_resample</span> <span class="kw">=</span> <span class="no">GOF_model_resample</span>$<span class="fu">new</span>(
    <span class="kw">gof_model_simulator</span> <span class="kw">=</span> <span class="no">GOF_glm_sim_param</span>$<span class="fu">new</span>(),
    <span class="kw">gof_model_trainer</span> <span class="kw">=</span> <span class="no">my_negbin_trainer</span>$<span class="fu">new</span>()
  )
)
<span class="no">mt</span>$<span class="fu">get_pvalue</span>()
<span class="co">#&gt; [1] 0.36</span></pre></body></html></div>
<p>Lets compare the result with the default GOF-test for glmâ€™s</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="no">mt2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/GOF_model.html">GOF_model</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">fit</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>,
  <span class="kw">nmb_boot_samples</span> <span class="kw">=</span> <span class="fl">100</span>,
  <span class="kw">simulator_type</span> <span class="kw">=</span> <span class="st">"parametric"</span>,
  <span class="kw">y_name</span> <span class="kw">=</span> <span class="st">"y"</span>,
  <span class="kw">Rn1_statistic</span> <span class="kw">=</span> <span class="no">Rn1_CvM</span>$<span class="fu">new</span>()
)
<span class="co">#&gt; Warning in GOF_model(model = fit, data = d, nmb_boot_samples = 100,</span>
<span class="co">#&gt; simulator_type = "parametric", : The GOF-test requires to refit the model.</span>
<span class="co">#&gt; Refitting MASS::glm.nb can be problematic, see vignette New-Models</span>
<span class="no">mt2</span>$<span class="fu">get_pvalue</span>()
<span class="co">#&gt; [1] 0.36</span></pre></body></html></div>
<p>In this case the p-values do not differ. However, it could be different in other settings.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Marsel Scheer, Gerhard Dikta.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
